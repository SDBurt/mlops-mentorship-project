version: 2

models:
  # ==========================================================================
  # Staging Model: Payment Events
  # ==========================================================================
  - name: stg_payment_events
    description: |
      Staging table for all payment events from PostgreSQL bronze layer.
      Includes ML enrichment fields (fraud score, churn prediction, retry strategy)
      from Temporal workflow processing.
      Ingested by Dagster from PostgreSQL to Iceberg.
    config:
      tags: ['staging', 'payments']
    columns:
      - name: event_id
        description: "Unique event identifier (provider:original_id format)"
        tests:
          - unique
          - not_null

      - name: provider
        description: "Payment provider (stripe, square, etc.)"
        tests:
          - not_null

      - name: event_type
        description: "Normalized event type"
        tests:
          - not_null

      - name: customer_id
        description: "Customer identifier"

      - name: merchant_id
        description: "Merchant identifier"

      - name: amount_cents
        description: "Transaction amount in cents"

      - name: currency
        description: "ISO 4217 currency code"

      - name: status
        description: "Payment status"
        tests:
          - not_null

      - name: fraud_score
        description: "Fraud probability score (0-1) from inference service"

      - name: risk_level
        description: "Risk level classification"

      - name: churn_score
        description: "Customer churn probability score (0-1)"

      - name: event_category
        description: "Derived event category (charge, refund, dispute, subscription, failed_payment, other)"
        tests:
          - accepted_values:
              values: ['charge', 'refund', 'dispute', 'subscription', 'failed_payment', 'other']

      - name: ingested_at
        description: "When Dagster ingested to Iceberg"
        tests:
          - not_null
