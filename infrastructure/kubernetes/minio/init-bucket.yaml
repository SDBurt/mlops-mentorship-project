---
# Job to create default bucket in MinIO
# IMPORTANT: MinIO credentials should be provided via Secret
# Create secret: kubectl create secret generic minio-credentials \
#   --from-literal=access-key-id=admin \
#   --from-literal=secret-access-key=YOUR_PASSWORD \
#   -n lakehouse
apiVersion: batch/v1
kind: Job
metadata:
  name: minio-create-bucket
  namespace: lakehouse
spec:
  template:
    spec:
      restartPolicy: OnFailure
      containers:
      - name: mc
        image: minio/mc:latest
        env:
        # MinIO credentials from Secret
        - name: MINIO_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: access-key-id
              optional: true
        - name: MINIO_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: secret-access-key
              optional: true
        command:
        - /bin/sh
        - -c
        - |
          # Use environment variables or fallback to defaults (development only)
          ACCESS_KEY="${MINIO_ACCESS_KEY:-admin}"
          SECRET_KEY="${MINIO_SECRET_KEY:-CHANGEME_MINIO_PASSWORD}"
          
          # Wait for MinIO to be ready
          until mc alias set myminio http://minio:9000 "${ACCESS_KEY}" "${SECRET_KEY}"; do
            echo "Waiting for MinIO to be ready..."
            sleep 2
          done

          # Create bucket if it doesn't exist
          mc mb myminio/lakehouse --ignore-existing

          echo "Bucket 'lakehouse' created successfully"
