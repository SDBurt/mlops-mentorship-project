# Payments PostgreSQL Configuration (Bitnami Helm Chart)
# Deployed using: helm install payments-db bitnami/postgresql -n lakehouse -f values.yaml
#
# This is the bronze layer database for payment events before batch loading to Iceberg.
# Internal access: payments-db-postgresql.lakehouse.svc.cluster.local:5432

# Allow non-standard images (required for bitnamilegacy)
global:
  security:
    allowInsecureImages: true

# Use bitnamilegacy since bitnami deprecated Docker Hub images (Aug 2025)
image:
  registry: docker.io
  repository: bitnamilegacy/postgresql
  tag: 17.2.0-debian-12-r10

# Authentication
auth:
  username: payments
  database: payments
  existingSecret: payments-db-secret
  secretKeys:
    userPasswordKey: password
    adminPasswordKey: postgres-password

# Primary configuration
primary:
  # Persistence
  persistence:
    enabled: true
    size: 10Gi
    storageClass: ""

  # Resources
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

  # Init scripts - create payment tables
  initdb:
    scriptsConfigMap: payments-db-init

  # PostgreSQL configuration
  configuration: |
    max_connections = 100
    shared_buffers = 128MB
    effective_cache_size = 256MB
    work_mem = 4MB
    maintenance_work_mem = 64MB
    checkpoint_completion_target = 0.9
    wal_buffers = 4MB
    default_statistics_target = 100
    random_page_cost = 1.1
    effective_io_concurrency = 200

# No read replicas for development
readReplicas:
  replicaCount: 0

# Service configuration
service:
  type: ClusterIP
  ports:
    postgresql: 5432

# Security
containerSecurityContext:
  runAsUser: 1001
  runAsNonRoot: true
  allowPrivilegeEscalation: false

# Metrics (optional)
metrics:
  enabled: false
